import{_ as a,c as e,a0 as i,o as t}from"./chunks/framework.BGabeMLJ.js";const c=JSON.parse('{"title":"OpenEBS/Mayastor for FLAME (optional)","description":"","frontmatter":{},"headers":[],"relativePath":"guide/deployment/hub-storage.md","filePath":"guide/deployment/hub-storage.md"}'),l={name:"guide/deployment/hub-storage.md"};function n(o,s,h,p,r,d){return t(),e("div",null,s[0]||(s[0]=[i(`<h1 id="openebs-mayastor-for-flame-optional" tabindex="-1">OpenEBS/Mayastor for FLAME (optional) <a class="header-anchor" href="#openebs-mayastor-for-flame-optional" aria-label="Permalink to &quot;OpenEBS/Mayastor for FLAME (optional)&quot;">â€‹</a></h1><p>OpenEBS is a chart that provides extra storage options. We will be using Mayastor Replicated Storage to synchronize Persistent Volumes across multiple nodes in the cluster. This aims to ensure no data is lost when a node fails. With extra configuration, it enables automatic failover.</p><p>If you want to enable storage replication, you need to:</p><ol><li>Prepare your k8s nodes</li><li>Install OpenEBS into your k8s cluster</li><li>Configure your Application (FLAME Hub) to use the new storage class</li></ol><h2 id="node-setup" tabindex="-1">Node Setup <a class="header-anchor" href="#node-setup" aria-label="Permalink to &quot;Node Setup&quot;">â€‹</a></h2><p>Before installing OpenEBS, you must prepare the k8s nodes you want to use for mayastor.</p><h3 id="automatic-script-ðŸ¤–" tabindex="-1">Automatic script ðŸ¤– <a class="header-anchor" href="#automatic-script-ðŸ¤–" aria-label="Permalink to &quot;Automatic script ðŸ¤–&quot;">â€‹</a></h3><p>Use the script <code>prepare_for_mayastor.sh</code>.</p><blockquote><p>The script has been tested in Debian.</p><p>The script can safely be run multiple times.</p></blockquote><p>Download the script: <a href="https://github.com/PrivateAIM/hub-deployment/tree/master/scripts" target="_blank" rel="noreferrer">prepare_for_mayastor.sh</a></p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">chmod</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> +x</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> prepare_for_mayastor.sh</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ./prepare_for_mayastor.sh</span></span></code></pre></div><p>Alternatively, you can manually do the following:</p><h3 id="_1-configure-hugepages" tabindex="-1">1. Configure hugepages <a class="header-anchor" href="#_1-configure-hugepages" aria-label="Permalink to &quot;1. Configure hugepages&quot;">â€‹</a></h3><p>Enable hugepages:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1024</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /sys/kernel/mm/hugepages/hugepages-2048kB/nr_hugepages</span></span></code></pre></div><p>Persist hugepages and apply:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;vm.nr_hugepages = 1024&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/sysctl.d/20-microk8s-hugepages.conf</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sysctl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --system</span></span></code></pre></div><h3 id="_2-load-nvme-of-module" tabindex="-1">2. Load NVMe-oF module <a class="header-anchor" href="#_2-load-nvme-of-module" aria-label="Permalink to &quot;2. Load NVMe-oF module&quot;">â€‹</a></h3><p>Load the module immediately:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">modprobe</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nvme-tcp</span></span></code></pre></div><p>Persist the module across reboots:</p><ul><li>If <code>/etc/modules-load.d/nvme-tcp.conf</code> does not exist or does not contain <code>nvme-tcp</code>, create it with:</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;nvme-tcp&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/modules-load.d/nvme-tcp.conf</span></span></code></pre></div><h3 id="_3-verify" tabindex="-1">3. Verify <a class="header-anchor" href="#_3-verify" aria-label="Permalink to &quot;3. Verify&quot;">â€‹</a></h3><p>Check hugepages:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">grep</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> HugePages_Total</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /proc/meminfo</span></span></code></pre></div><p>Check the module is active:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">lsmod</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nvme_tcp</span></span></code></pre></div><h3 id="_4-label-the-node-for-mayastor" tabindex="-1">4. Label the node for Mayastor <a class="header-anchor" href="#_4-label-the-node-for-mayastor" aria-label="Permalink to &quot;4. Label the node for Mayastor&quot;">â€‹</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> label</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> node</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">node_nam</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> openebs.io/engine=mayastor</span></span></code></pre></div><h2 id="installing-openebs" tabindex="-1">Installing OpenEBS <a class="header-anchor" href="#installing-openebs" aria-label="Permalink to &quot;Installing OpenEBS&quot;">â€‹</a></h2><p>The FLAME Helm repository provides a <a href="https://github.com/PrivateAIM/helm/blob/master/charts/third-party/openebs" target="_blank" rel="noreferrer">wrapper chart for OpenEBS</a> with some suggested default values. Installing this chart will add a new StorageClass to your cluster. You can tell workloads of the Flame Hub to use this StorageClass by specifying it in <code>flame-hub/values.yaml</code>. Usually, only stateful workloads (StatefulSets) need replicated storage.</p><ol><li><strong>Clone the <a href="https://github.com/PrivateAIM/helm/" target="_blank" rel="noreferrer">Flame Helm Repository</a> and navigate to <code>charts/third-party/openebs</code></strong></li><li>Make sure you have 3 nodes in your cluster.</li><li>Make sure you have read the previous section on node preparation for mayastor. <ul><li>If not already labeled, label your nodes: <code>kubectl label node &lt;node_name&gt; openebs.io/engine=mayastor</code></li></ul></li><li>Clone <code>values.yaml</code> to <code>values_local.yaml</code>.</li><li>Fill in your kubelet path and populate the disk pools section with your unmounted drives.</li><li>Install the chart:</li></ol><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">helm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dependency</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> update</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> .</span></span></code></pre></div><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">helm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> openebs</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> .</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --namespace</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> openebs</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --create-namespace</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> values_local.yaml</span></span></code></pre></div><ol start="7"><li>Verify disk pools and <code>mayastor</code> storage classes:</li></ol><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> diskpools</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> openebs</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> storageclasses</span></span></code></pre></div><ol start="8"><li>Edit your FLAME-Hub values-file to use the new StorageClass. A reinstall of the Hub will probably be required.</li></ol><h2 id="use-the-new-storage-class" tabindex="-1">Use the new storage class <a class="header-anchor" href="#use-the-new-storage-class" aria-label="Permalink to &quot;Use the new storage class&quot;">â€‹</a></h2><p>In your <code>values.yaml</code> (or better <code>values_override.yaml</code>) you can specify the storage class for the different components of the FLAME Hub.</p><p>Example:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">minio</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  persistence</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    storageClass</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;mayastor-replicated&quot;</span></span></code></pre></div>`,42)]))}const g=a(l,[["render",n]]);export{c as __pageData,g as default};
